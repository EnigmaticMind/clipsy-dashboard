name: Deploy to Chrome Web Store

on:
  push:
    tags:
      - "v*" # Trigger when a tag starting with 'v' is created/pushed
  workflow_dispatch: # Allow manual triggering
    inputs:
      tag:
        description: "Tag name to deploy (e.g., v1.0.0)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      packages: none

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true # Required for git push to work
          # For manual dispatch, checkout the specified tag
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Get version from tag
        id: get_version
        run: |
          # Determine tag name based on event type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use input tag
            TAG_NAME="${{ inputs.tag }}"
            echo "Manual trigger with tag: $TAG_NAME"
          else
            # Tag push event - extract from ref
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "Tag push event: $TAG_NAME"
          fi

          echo "Original tag name: $TAG_NAME"
          VERSION=${TAG_NAME#v}  # Remove 'v' prefix if present
          echo "After removing 'v' prefix: $VERSION"
          # Strip any pre-release identifiers (e.g., -alpha, -beta, -rc, etc.)
          VERSION=${VERSION%%-*}  # Remove everything after first hyphen
          echo "After stripping pre-release identifiers: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "✅ Final cleaned version: $VERSION (from tag: $TAG_NAME)"

      - name: Update code to match release version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "=== DEBUG: Starting version update ==="
          echo "Tag: ${GITHUB_REF#refs/tags/}"
          echo "Cleaned version from step: $VERSION"

          # Show current version before update
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current package.json version: $CURRENT_VERSION"

          # Force clean the version - strip everything after first hyphen
          CLEAN_VERSION=$(echo "$VERSION" | cut -d'-' -f1)
          echo "Force cleaned version: $CLEAN_VERSION"

          # Update package.json with the cleaned version
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const oldVersion = pkg.version;
            // Force strip any pre-release identifiers
            const cleanVersion = '$CLEAN_VERSION'.split('-')[0].trim();
            pkg.version = cleanVersion;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Version updated from', oldVersion, 'to', cleanVersion);
          "

          # Verify the version was set correctly
          ACTUAL_VERSION=$(node -p "require('./package.json').version")
          echo "=== DEBUG: After update ==="
          echo "Actual package.json version: $ACTUAL_VERSION"

          # Show the actual file content to verify
          echo "=== package.json version field ==="
          grep -A 1 '"version"' package.json

          # Double-check - if it still has a hyphen, something is wrong
          if [[ "$ACTUAL_VERSION" == *"-"* ]]; then
            echo "❌ CRITICAL ERROR: Version still contains pre-release identifier: $ACTUAL_VERSION"
            echo "Attempting to fix by force-stripping..."
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = pkg.version.split('-')[0];
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            ACTUAL_VERSION=$(node -p "require('./package.json').version")
            echo "After force fix: $ACTUAL_VERSION"
            if [[ "$ACTUAL_VERSION" == *"-"* ]]; then
              echo "❌ Failed to fix version. Aborting."
              exit 1
            fi
          fi

          echo "✅ Version updated to: $ACTUAL_VERSION (no pre-release identifiers)"

      # Version is already updated in "Update code to match release version" step
      # The build will use the updated version from package.json
      # No need to commit/push since the tag already represents the release

      - name: Set version output
        id: version
        run: |
          echo "version=${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify version before build
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Package.json version before build: $PKG_VERSION"

          # Verify it doesn't contain pre-release identifiers
          if [[ "$PKG_VERSION" == *"-"* ]]; then
            echo "❌ Error: package.json version contains pre-release identifier: $PKG_VERSION"
            exit 1
          fi

          echo "✅ Version validated: $PKG_VERSION"

      - name: Debug version before build
        run: |
          echo "=== DEBUG: Starting Debug version before build ==="
          echo "Package.json version: $(node -p "require('./package.json').version")"
          echo "✅ Debug version verified."

      - name: Build extension
        run: npm run build

      - name: Verify manifest version after build
        run: |
          # Extract version from built manifest.json
          if [ -f "dist/manifest.json" ]; then
            echo "=== DEBUG: Checking built manifest ==="
            MANIFEST_VERSION=$(node -p "require('./dist/manifest.json').version")
            echo "Built manifest.json version: $MANIFEST_VERSION"
            echo "Full manifest.json version field:"
            grep -A 1 '"version"' dist/manifest.json || echo "Version field not found"
            
            if [[ "$MANIFEST_VERSION" == *"-"* ]]; then
              echo "❌ CRITICAL ERROR: Built manifest.json contains pre-release identifier: $MANIFEST_VERSION"
              echo "This will cause Chrome Web Store upload to fail!"
              echo ""
              echo "Debugging info:"
              echo "  Package.json version: $(node -p "require('./package.json').version")"
              echo "  Manifest.json version: $MANIFEST_VERSION"
              exit 1
            fi
            
            EXPECTED_VERSION="${{ steps.get_version.outputs.version }}"
            if [[ -n "$EXPECTED_VERSION" && "$MANIFEST_VERSION" != "$EXPECTED_VERSION" ]]; then
              echo "⚠️  Warning: Manifest version mismatch! Expected $EXPECTED_VERSION but got $MANIFEST_VERSION"
            fi
            
            echo "✅ Manifest version validated: $MANIFEST_VERSION"
          else
            echo "❌ ERROR: dist/manifest.json not found!"
            exit 1
          fi

      - name: Create zip file
        run: |
          cd dist
          zip -r ../clipsy-extension.zip . -x "*.map" "*.DS_Store" "*.log"
          cd ..
          ls -lh clipsy-extension.zip

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CHROME_EXTENSION_ID }}" ]; then
            echo "❌ Error: CHROME_EXTENSION_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_CLIENT_ID }}" ]; then
            echo "❌ Error: CHROME_CLIENT_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_CLIENT_SECRET }}" ]; then
            echo "❌ Error: CHROME_CLIENT_SECRET secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_REFRESH_TOKEN }}" ]; then
            echo "❌ Error: CHROME_REFRESH_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - name: Upload to Chrome Web Store
        run: |
          node scripts/upload-to-chrome-store.js \
            "${{ secrets.CHROME_EXTENSION_ID }}" \
            "${{ secrets.CHROME_CLIENT_ID }}" \
            "${{ secrets.CHROME_CLIENT_SECRET }}" \
            "${{ secrets.CHROME_REFRESH_TOKEN }}" \
            "./clipsy-extension.zip" \
            "false"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipsy-extension
          path: clipsy-extension.zip
          retention-days: 30
