name: Deploy to Chrome Web Store

on:
  push:
    tags:
      - "v*" # Trigger when a tag starting with 'v' is created/pushed
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push version updates back to the repo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true # This makes the token available for git push
          ref: ${{ github.ref }} # Use the tag ref

      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Original tag name: $TAG_NAME"
          VERSION=${TAG_NAME#v}  # Remove 'v' prefix if present
          echo "After removing 'v' prefix: $VERSION"
          # Strip any pre-release identifiers (e.g., -alpha, -beta, -rc, etc.)
          VERSION=${VERSION%%-*}  # Remove everything after first hyphen
          echo "After stripping pre-release identifiers: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "✅ Final cleaned version: $VERSION (from tag: $TAG_NAME)"

      - name: Update code to match release version
        if: github.event_name == 'release'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Updating package.json to version: $VERSION"

          # Show current version before update
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current package.json version: $CURRENT_VERSION"

          # Strip any pre-release identifiers from current version (safety check)
          CLEANED_CURRENT=${CURRENT_VERSION%%-*}
          if [[ "$CURRENT_VERSION" != "$CLEANED_CURRENT" ]]; then
            echo "⚠️  Current version contains pre-release identifier, will be cleaned: $CURRENT_VERSION -> $CLEANED_CURRENT"
          fi

          # Ensure the target version is clean (double-check)
          CLEANED_VERSION=${VERSION%%-*}
          if [[ "$VERSION" != "$CLEANED_VERSION" ]]; then
            echo "⚠️  Target version contains pre-release identifier, cleaning: $VERSION -> $CLEANED_VERSION"
            VERSION=$CLEANED_VERSION
          fi

          # Update package.json directly using node (more reliable than npm version)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            console.log('Old version:', pkg.version);
            // Strip any pre-release identifiers from the version
            const cleanVersion = '$VERSION'.split('-')[0];
            pkg.version = cleanVersion;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('New version:', pkg.version);
          "

          # Verify the version was set correctly
          ACTUAL_VERSION=$(node -p "require('./package.json').version")
          echo "✅ Updated package.json to version: $ACTUAL_VERSION"

          if [[ "$ACTUAL_VERSION" != "$VERSION" ]]; then
            echo "❌ Error: Version mismatch! Expected $VERSION but got $ACTUAL_VERSION"
            exit 1
          fi

          # Verify no pre-release identifiers
          if [[ "$ACTUAL_VERSION" == *"-"* ]]; then
            echo "❌ Error: Version still contains pre-release identifier: $ACTUAL_VERSION"
            exit 1
          fi

          echo "✅ Version updated and validated (no pre-release identifiers). manifest.ts will use this version when built."

      - name: Commit version update
        if: github.event_name == 'release'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          BRANCH="${{ github.event.release.target_commitish }}"

          # Ensure we're on the correct branch
          git checkout -B $BRANCH || git checkout $BRANCH

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json src/manifest.ts 2>/dev/null || git add package.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No version changes to commit (already matches release version)"
          else
            git commit -m "Update version to $VERSION to match release ${{ github.event.release.tag_name }}" || echo "Commit failed"
            
            # Configure git to use the token
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            
            # Push to the branch
            git push origin $BRANCH || {
              echo "⚠️  Push failed. This might be due to branch protection rules."
              echo "The version has been updated locally but not pushed to the remote."
              exit 1
            }
            echo "✅ Committed and pushed version update to $BRANCH"
          fi

      - name: Set version output
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ steps.bump_version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify version before build
        if: github.event_name == 'release'
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Package.json version before build: $PKG_VERSION"

          # Verify it doesn't contain pre-release identifiers
          if [[ "$PKG_VERSION" == *"-"* ]]; then
            echo "❌ Error: package.json version contains pre-release identifier: $PKG_VERSION"
            exit 1
          fi

          echo "✅ Version validated: $PKG_VERSION"

      - name: Build extension
        run: npm run build

      - name: Verify manifest version after build
        if: github.event_name == 'release'
        run: |
          # Extract version from built manifest.json
          if [ -f "dist/manifest.json" ]; then
            MANIFEST_VERSION=$(node -p "require('./dist/manifest.json').version")
            echo "Built manifest.json version: $MANIFEST_VERSION"
            
            if [[ "$MANIFEST_VERSION" == *"-"* ]]; then
              echo "❌ Error: Built manifest.json contains pre-release identifier: $MANIFEST_VERSION"
              echo "This will cause Chrome Web Store upload to fail!"
              exit 1
            fi
            
            EXPECTED_VERSION="${{ steps.get_version.outputs.version }}"
            if [[ "$MANIFEST_VERSION" != "$EXPECTED_VERSION" ]]; then
              echo "❌ Error: Manifest version mismatch! Expected $EXPECTED_VERSION but got $MANIFEST_VERSION"
              exit 1
            fi
            
            echo "✅ Manifest version validated: $MANIFEST_VERSION"
          else
            echo "⚠️  Warning: dist/manifest.json not found"
          fi

      - name: Create zip file
        run: |
          cd dist
          zip -r ../clipsy-extension.zip . -x "*.map" "*.DS_Store" "*.log"
          cd ..
          ls -lh clipsy-extension.zip

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CHROME_EXTENSION_ID }}" ]; then
            echo "❌ Error: CHROME_EXTENSION_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_CLIENT_ID }}" ]; then
            echo "❌ Error: CHROME_CLIENT_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_CLIENT_SECRET }}" ]; then
            echo "❌ Error: CHROME_CLIENT_SECRET secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CHROME_REFRESH_TOKEN }}" ]; then
            echo "❌ Error: CHROME_REFRESH_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - name: Upload to Chrome Web Store
        run: |
          node scripts/upload-to-chrome-store.js \
            "${{ secrets.CHROME_EXTENSION_ID }}" \
            "${{ secrets.CHROME_CLIENT_ID }}" \
            "${{ secrets.CHROME_CLIENT_SECRET }}" \
            "${{ secrets.CHROME_REFRESH_TOKEN }}" \
            "./clipsy-extension.zip" \
            "false"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: clipsy-extension
          path: clipsy-extension.zip
          retention-days: 30
